---
title: "Problem Set IV Solution"
author: 
  - "Tobias Bodentien"
  - "Philipp Grunenberg"
  - "Alexander Haas"
  - "Osama Warshagha"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"

output:
  pdf_document:
    latex_engine: xelatex
    citation_package: biblatex
bibliography: references.bib
editor_options: 
  markdown: 
    wrap: sentence
---

# Task 1

In this task we design an reduced experimental design to study the impact of different car setup parameters and strategy-related factors.
As seen in the last problem set we have several variables. Some of those variables are predetermined and track specific. Since they do not vary within the practice or the race and are fixed we cannot include them in the experimental design.
The setup variables can be influenced by the racing team. Those are "Rear Wing", "Front Wing", "Engine", "Brake Balance", "Differential" and "Suspension". In this problem set we additionally have strategy relevant variables. We can now choose how many pitstops we do and when we do them, tyres and fuel load. 
Since we do not have any previous data on the strategy relevant variables it is important to learn about the influences of those on the lap time and overall race time. It is of significant importance to find out how durable the tyres are and how they influence the lap time. The same applies to fuel load. It is also important to do some pit stops to estimate how much time is lost per pit stop. Since the pit stops are determined by tyre changes we do not explicitly include them as a factor in the experimental design as we learn about them indirectly. The fuel load will decrease during the practice. Therefore we do not include it explicitly as a factor in the experimental design and just fuel up the car to the maximum after every tyre change.

The LASSO results of the previous problem set indicate that lap time is strongly influenced by several car setup parameters and their interactions with track and environmental conditions. Every retained variable involves at least one controllable car feature. In particular, brake balance, differential, engine, and front and rear wing settings appear repeatedly with sizable coefficients, suggesting that drivetrain and aerodynamic configuration are key performance drivers. 
Therefore, we choose all setup variables as strong drivers of performance.

From the previous problem set we know that the relationship between car setup variables and lap times is  non-linear. While a two-level design can only identify general trends, the inclusion of a medium value allows the model to capture curvature and diminishing returns, which are critical for identifying the "sweet spot" in a complex mechanical system. 
However, a three-level design may oversimplify the complex physical interactions of racecar dynamics. A response surface with only three points assumes a symmetric curvature, which risks missing the true optimum if the performance curve is skewed or asymptotic. By extending the design to five levels, we gain the resolution necessary to capture higher-order non-linearities and subtle changes in vehicle behavior. This finer granularity is critical for distinguishing between a broad performance plateau and a narrow, sensitive peak, ensuring that the final optimal setting is precise rather than just an approximation between two extremes.

Regarding the tyres we expect that a softer compound results in faster lap times but higher degradation. For the qualifying the super-soft tyre therefore makes sense. It is still important to use the other three tyres to learn when it makes sense to use a softer tyre with an additional pit stop as opposed to a harder tyre.
The resulting factors that we believe influence the lap time are:
\begin{itemize} 
\item Rear Wing: 10 / 130 / 250 / 370 / 500 
\item Front Wing: 10 / 130 / 250 / 370 / 500 
\item Engine: 10 / 130 / 250 / 370 / 500 
\item Brake Balance: 10 / 130 / 250 / 370 / 500 
\item Differential: 10 / 130 / 250 / 370 / 500 
\item Suspension: 10 / 130 / 250 / 370 / 500 
\item Tyre: super-soft / soft / medium / hard \end{itemize}

From the Team Analytics Website we get the following information from Gunnar:
"One thing we did was to debunk the myth that setup should be changed according to fuel load or the tyres."
This implies that setup factors can be optimized independently of tyres and fuel load. And strategy factors can be evaluated holding setup fixed. This allows us to separate the experiment into two phases.

In the first phase we estimate the main effects of the six setup variables, holding tyre compound and fuel strategy constant. As a full factorial design is not feasible we use D-optimality to come up with an experimental design, which maximizes the precision of the car setup coefficients given a limited amount of experimental runs (70=120- 50 laps for phase 2).
```{r, echo=FALSE}
library(AlgDesign)
levels_5 <- c(10, 130, 250, 370, 500)

setup_candidates <- expand.grid(
  RearWing     = levels_5,
  FrontWing    = levels_5,
  Engine       = levels_5,
  BrakeBalance = levels_5,
  Differential = levels_5,
  Suspension   = levels_5
)

phase1_model <- ~ RearWing + I(RearWing^2) +
                  FrontWing + I(FrontWing^2) +
                  Engine + I(Engine^2) +
                  BrakeBalance + I(BrakeBalance^2) +
                  Differential + I(Differential^2) +
                  Suspension + I(Suspension^2)

set.seed(123)

phase1_design <- optFederov(
  frm       = phase1_model,
  data      = setup_candidates,
  nTrials   = 70,      # reduced number of practice laps
  criterion = "D"
)

#print(paste("D-efficiency:",phase1_design$Dea))

# The actual experimental plan
phase1_plan <- phase1_design$design
cor_matrix <- cor(phase1_plan)
off_diag_elements <- cor_matrix[row(cor_matrix) != col(cor_matrix)]
max_abs_corr <- max(abs(off_diag_elements))
#print(paste("Maximum absolute off-diagonal correlation:", max_abs_corr))

#print(phase1_plan)


```

The resulting design achieves a solid D-efficiency of 42,1% and maintains low correlations between the factors with the larges absolute correlation being 0,16. This ensures that the influence of each individual parameter can be statistically isolated during analysis. Consequently, this approach maximizes the information gathered about the vehicle's performance while significantly minimizing the total number of practice laps required for testing when compared to a full factorial design.

In the second phase the setup is fixed and we compare tyre compounds to understand lap time and degradation trade-offs as well as implicit pit stop costs.
Because the number of strategy factors is small and the factor levels are few, a full factorial design is feasible and preferred, as it allows unbiased and transparent comparison of all tyre compounds without confounding. This full factorial design ensures that differences in lap time and degradation across tyre types can be directly attributed to the tyre choice, providing a clear basis for race strategy decisions. We assume that softer tyre compounds degrade faster but achieve shorter lap times than harder compounds. To efficiently learn about degradation behavior under a limited lap budget, we run longer stints on the extreme compounds (super-soft and hard), which are expected to bracket the degradation patterns of the intermediate compounds. Shorter stints on the soft and medium tyres are still included to directly observe their performance levels, while the longer stints on the extremes improve identification of degradation dynamics. Therefore we decide to run 15 laps on the super-soft, 25 laps on the hard tyre and 5 laps on the soft and medium tyre each.

```{r, echo=FALSE}
# Fixed setup from Phase 1 optimum
fixed_setup <- data.frame(
  RearW     = 500,
  FrontW    = 500,
  Engine       = 500,
  BrakeBalance = 500,
  Differential = 500,
  Suspension   = 10
)

# Define stint lengths per tyre compound
laps_per_tyre <- data.frame(
  Tyre = factor(c("super_soft", "soft", "medium", "hard"),
                levels = c("super_soft", "soft", "medium", "hard")),
  Laps = c(15, 5, 5, 25)
)

# Create full factorial design within each tyre compound
strategy_factors <- do.call(
  rbind,
  lapply(1:nrow(laps_per_tyre), function(i) {
    data.frame(
      Tyre = laps_per_tyre$Tyre[i],
      Lap  = 1:laps_per_tyre$Laps[i]
    )
  })
)

# Combine fixed setup with strategy design
phase2_design <- cbind(
  fixed_setup[rep(1, nrow(strategy_factors)), ],
  strategy_factors
)

# Inspect design
table(phase2_design$Tyre)
head(phase2_design)

```
1. Experiment: 25 Laps, Hart, mit 120 Fuel
--> Reifen degradiert linear
--> Fuel level linear abnehmend
--> Einfluss von Fuel auf Laptime scheint gr√∂√üer zu sein von Reifen (da Rundenzeit sinkt)

2. Experiment: 2 Laps, Soft, 5 Fuel
--> Fuel level linear abnehmend, egal welcher Reifen drauf ist
--> Reifen degration h√∂her f√ºr weichen Reifen

Idee: Wenn Fuel und Reifen unabh√§ngig von einander degradieren, k√∂nnen wir mehrere Stints mit einer Runde fahren, um immer mit neuem Reifen zu starten (diesen also konstant halten). So k√∂nnen wir, wenn wir den Fuel √§ndern, den Einfluss von Fuel auf die Rundenzeit ermitteln.

3. Experiment: 5 Stints a 1 Runde, Soft, Fuel 100/80/60/40/20, weil 120 haben wir ja schon.

Um zu pr√ºfen, ob das Fuel Level mit unterschiedlichen Reifen einen Einfluss auf die Rundenzeit hat, machen wir das dritte Experiment nochmal mit dem harten Reifen.


4. Experiment: 5 Stints a 1 Runde, Hart, Fuel 100/80/60/40/20, weil 120 haben wir ja schon

Dann m√ºssen wir nur noch die unterschiedlichen Reifen testen.
4. Experiment: 15 Runden, Soft, Fuel 120

5. Experiment: 3 Runden, Medium, Fuel 120

Frage: M√ºssen wir dieses Experiment f√ºr alle Reifen durchf√ºhren?
Frage: K√∂nnen wir den Fehler, der auf die Rundenzeit addiert wird absch√§tzen?


Erkenntnisse:
Reifen degradiert linear, aber unterschiedlich f√ºr Reifenmischung
Fuel level linear abnehmend, egal welcher Reifen drauf ist
Super soft l√§sst sich nicht fahren, wahrscheinlich weil es zu warm ist
Pitstops k√∂nnen in der Practice nicht simuliert werden (es kann nicht mit zu wenig Sprit gestartet werden)










# Task 2
F√ºr das Rennen in England soll ausschlie√ülich mit der Multi-Armed-Bandit (MAB) Methode gearbeitet werden, die f√ºr das vorliegende Problem relativ ungeeignet ist. Es soll ein sehr gro√üer Parameterraum ohne zus√§tzliche Anwendung von more involved modeln mit nur sehr wenigen Ziehungen aus den zugrundeliegenden Verteilungen erkundet werden, um ein optimales Setup und eine optimale Strategie f√ºr das Rennen zu finden. 

Aus den verschiedenen Setup- und Strategieparametern gemeinsame Tupel zu bilden, ist dank der Unabh√§ngigkeit des Setups von den Reifen nicht n√∂tig (ein Setup das auf "soft" besser funktioniert ist auch konsistent auf "hard" besser. Demnach wird im Folgenden das Problem in zwei Teilprobleme unterteilt:
1. Bestimmung des besten Setups aus einer vordefinierten Menge an m√∂glichen Setups.
2. Ableitung der bestm√∂glichen Strategie aus einer vordefinierten Menge an m√∂glichen Strategien.

Dass nur sehr wenige √úbungsrunden zu Verf√ºgung stehen hat nicht nur Auswirkung auf die Menge der m√∂glichen Tupel, die verglichen werden, sondern auch auf die Wahl, welcher MAB Algorithmus verwendet wird.
Hier jetzt √ºber epsilon greedy, ucb und thompson sprechen. Thompson zitieren f√ºr den Fall dass nur wenige Pulls zur Verf√ºgung stehen kann sich Thompson schnell auf eine option einschie√üen, die f√ºr das vorliegende problem suboptimal ist. F√ºr das Setting wie es hier gegeben ist bieten sich algorithmen an, die einen starken Fokus auf exploration legen oder ausschlie√ülich explorieren. 

## 1. Bestimmung des Setup
Aufgrund der limitierten Anzahl an √úbungsrunden besteht ein Trade-off zwischen der Anzahl der Bandit-Arme (d. h. Setup-Parameter-Tupeln) und der Anzahl an √úbungsrunden pro Arm. Wenn zu viele verschiedene Tupel erkundet werden, entfallen auf jeden Arm zu wenige √úbungsrunden, sodass die Performance-Sch√§tzungen stark verrauscht und damit wenig aussagekr√§ftig sind. Die Setup-Tupel werden im Folgenden so gew√§hlt, dass eine m√∂glichst breite Abdeckung des Parameterraums unter Ber√ºcksichtigung der Streckencharakteristik erzielt wird.


Die Track characterstics von England zeigen folgendes Bild auf: cornering ist gering (23/100), es herrscht ein sehr hohes level an grip (79/100) und die strecke ist  hoch gelegen (77/100) sowie nicht rough (1/100).

Folgende findings aus den vorherigen analysen und ber√ºcksichigung von informationen aus dem online-tool "Analytics GP" lassen eine Tendenz der Auswahl an Setups f√ºr den Bandit algorithmus zu.

### Aerodynamics
"Another point that we found was the importance of aerodynamic balance, indicating that downforce components must be tuned in concert rather than in isolation to maximize speed" (our analysis). Das impliziert keine verschiedenen werte von rear und front wing zu verwenden. "Car wing angles should be set higher in tracks with more corners" (Analytics GP). Das entspricht der klassischen Empfehlung einer low donforce abstimmung f√ºr Strecken mit wenig kurven.

### Enginge
"High engine output induces detrimental wheel spin in low-grip environments, while proving advantageous on high-traction tracks" (our anaylsis). Therefore selecting higher engine output on high-traction tracks like England might translate into improved acceleration. Neverteless "pushing the car at high altitude might be suboptimal" (Analytics GP). Demach werden hier zwei sehr verschiedene Einstellungen von engine verwendet.

### Break Balance
Zu Break Balance wurden noch keine Erkenntnisse gesammelt, auch die Richtung der Break Balance ist nicht klar. Daher werden hier verschiedene extreme Werte ausprobiert.

### Differential
"High-cornering circuits require frequent shifting, thereby amplifying the utility of the differential. The adverse impact of larger differential settings mitigates‚Äîand eventually vanishes, as track cornering intensity increases" (our analysis). Demnach sollte das Differential f√ºr den England GP eher konservativ eingestellt werden und wird zur Vereinfachung der Suche f√ºr fast alle Tupel konstant auf 100 gelassen.

### Suspension
F√ºr Frankreich war ein Trend hin zu sehr niedriger Suspension einstellung zu sehen. Dies k√∂nnte zu der Charakteristik der relativ roughen strecke passen. Nachdem England nur extrem nicht rough ist, werden bei den folgenden setup varianten der fokus st√§rker auf eine h√§rtere Suspension einstellung gelegt, wobei ein Arm jedoch einen absichtlich niedrien wert als absicherung enth√§lt.


| Arm      | Rear Wing | Front Wing | Engine | Brake | Differential | Suspension |
|---------:|----------:|-----------:|-------:|------:|-------------:|-----------:|
| A1       | 250       | 250        | 300    | 250   | 250          | 250        |
| A2       |  10       |  10        | 400    | 250   | 100          | 450        |
| A3       |  10       |  10        | 100    | 250   | 100          | 450        |
| A4       | 100       | 100        | 400    | 500   | 100          | 200        |
| A5       | 100       | 100        | 100    |  50   | 100          | 200        |
| A6       | 150       | 150        | 400    |  50   | 100          | 500        |
| A7       | 300       | 300        | 350    | 500   | 100          |  50        |

Die angegebenen sieben Setup Varianten beinhalten ein balanced baseline setup (A1), mehrere variierende low downforce varianten (A2-A6) mit orientierung der parameter an den findings oben und ein medium downforce setup (A7). Damit wird versucht den Parameterraum m√∂glichst breit aufzuspannen und trotzdem einen Fokus auf low downforce zu legen.

### Successive Rejects Algorithm

hier zitat warum nicht espilon greedy oder thompson und dann paper successive reject algo mit verweis auf figure 3 algo.
warum SR gew√§hlt?


each pull stint length 1, fuel load 120, tyre selection hard

Anzahl der pulls je Runde

4 1 1 1 2 4


ergebnisse √ºber pfeilchart? 

7 -- eliminate A3 --> 6 -- eliminate A4 --> usw








## 2. Bestimmung der Strategie

Nachdem nun das Setup A1 als bestes unter den 7 m√∂glichen ausgew√§hlt wurde, sind noch 63 Trainingsrunden verf√ºgbar. Um die linearen konstanten f√ºr fuel abnahme und reifenverschlei√ü je compound zu bestimmen, werden drei weitere Runden ben√∂tigt (f√ºr extrasoft, soft, medium). Anhand diesen Konstanten kann im Folgenden ein  geeignetes Set an Strategien f√ºr den England GP festgelegt werden. 

Man erh√§lt dabei f√ºr die fuelabnahme je Runde einen Wert von z=3,23. Die compounds degradieren mit  w_extrasoft = 12,67, w_soft = 5,51, w_medium = 4,46 und w_hard = 3.67 pro Runde. Da der maximale Fuelload 120 ist und z kleiner als alle compound degradation constanten, ist fuel nie der limitierende faktor f√ºr die l√§nge eines stints.

Mit dieser Information und der Annahme linear abnehmender Fuel und Compound Werte (Vergleich Frankreich GP), werden nun die Arme f√ºr den Strategie-Bandit festgelet. Die grundlegende Erkenntnis aus den vorherigen Rennen dabei ist, dass es von gro√üem Vorteil ist mit niedrigen Fuel werten zu fahren. Um die Auswahl der Arme zu erleichtern werden als variablen f√ºr die verschiedenen Arme auschlie√ülich die riefenmischug und die anzahl der stops zugelassen. jede strategie beinhaltet also nur eine reifenmischung und verteilt dabei die Runden pro stint m√∂glichst gleichm√§√üig auf die 63 Rennrunden auf. Jeder Stint wird mit der minimal m√∂glichen betankung gestartet. Aus den sich daraus ergebenden fahrbaren Strategien, werden folgende ausgew√§hlt:

| Arm | Compound | w_comp | b | L1 | L2 | L3 | L4 | L5 |
|---|---|---:|---:|---:|---:|---:|---:|---:|
| A1 | hard   | 3.67 | 2 | 21 | 21 | 21 |  - |  - |
| A2 | medium | 4.46 | 3 | 16 | 16 | 16 | 15 |  - |
| A3 | soft   | 5.51 | 3 | 16 | 16 | 16 | 15 |  - |
| A4 | soft   | 5.51 | 4 | 13 | 13 | 13 | 12 | 12 |



Im n√§chsten Schritt muss sowohl der Multi-Armed-Bandit Algorithmus als auch die Zielfunktion anhand derer die Arme bewertet werden festgelegt werden. Das Hauptproblem hierbei ist es, einen m√∂glichst unbiaseden Sch√§tzer f√ºr die Rundenzeit f√ºr einen Stint zu erhalten. Da keine anderen Modelle wie Regression verwendet werden d√ºrden, ist unser Vorgehen foldendes:
Es handelt sich auch wie in der Suche nach dem Setup um ein Best-Arm-Identification problem. Hier wird jedoch nicht der SF-Algorithmus verwendet, sondern die extrem simple Uniform allocation strategie (vgl ...). Dabei wird die Anzahl der Pulls auf die Arme gleich verteilt. Da es von entscheidender Bedeutung ist einen bestm√∂glichen Estimate f√ºr die Stintl√§nge und damit f√ºr die Rennzeit der aktuell betrachteten STrategie zu erhalten, wird jeder Arm (also die vier STrategien) nur ein mal gezogen. Weiterhin ist es wichtig, dass die Sch√§tzungen der Stintzeit alle m√∂glichst vergleichbar sind und ein m√∂glichst geringer Bias durch die Scsh√§tzung induziert wird. F√ºr zwei stops ergeben sich 21 Runden pro Stint, f√ºr drei stops 16 usw.. Da nur noch 60 Runden verf√ºgbar sind wird folgendes Schema f√ºr die stinl√§nge beim Ziehen der Arme verwendet.


Der minimal fuel load f√ºr die Simulation wird so berechnet:
Let \(b\) denote the number of pitstops and \(L(b)\) be the target stint length.
For per-lap fuel consumption \(z=3.23\), the minimal fuel load is
\[
F(z,b) \;=\; \left\lceil L(b)\,z \right\rceil
\;=\; \left\lceil \left\lceil \frac{63}{b+1}\right\rceil \, z \right\rceil .
\]

F√ºr die verschiedenen Arme ergeben sich folgende werte:

| Arm | A1 | A2 | A3 | A4 |
|---|---:|---:|---:|---:|
| Compound | hard | medium | soft | soft |
| Target stint length \(L(b)\) | 21 | 16 | 16 | 13 |
| Simulated stint length | 19 | 15 | 15 | 11 |
| Minimal fuel load \(F(z,b)\) | 68 | 52 | 52 | 42 |

Aus diesen Stints werden schlie√ülich die average laptimes als basis f√ºr den reward des bandits verwendet. Die genaue Zielfunktion ist schlie√ülich eine Sch√§tzung der Gesamtrennzeit, wobei wie in Analytics-GP vermerkt 30 seconds pro pitstop verbucht werden:
\[
\widehat{\mathrm{RaceTime}}_{A_i}^{\mathrm{sim}}(b)
\;=\;
63\,\bar{y}_{\mathrm{sim}}
\;+\; 30\,b \, .
\]

Die recommendation f√ºr den output des best arms ist auch hier wieder das arithmetische mittel, was in diesem trivialen Fall mit einer Ziehung aus einer beobachtung besteht.



\parencite{audibert}





Es ist ein Bandit-Setting (du ziehst Arme, bekommst Rewards, willst am Ende den besten Arm empfehlen).

Die ‚Äûuniform allocation‚Äú ist ein nicht-adaptiver Bandit-Algorithmus: die Pulls werden vorab festgelegt (jeder Arm 
‚âà
ùëõ
/
ùêæ
‚âàn/K mal), unabh√§ngig von den beobachteten Rewards.

In der Literatur l√§uft das oft unter uniform exploration / round-robin / equal allocation und geh√∂rt eher zur pure exploration / best-arm identification-Ecke (du willst prim√§r den besten Arm finden), nicht zur klassischen ‚Äûminimiere kumulatives Regret‚Äú-Ecke.







# References
