---
title: "Problem Set IV Solution"
author: 
  - "Tobias Bodentien"
  - "Philipp Grunenberg"
  - "Alexander Haas"
  - "Osama Warshagha"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"

output:
  pdf_document:
    latex_engine: xelatex
editor_options: 
  markdown: 
    wrap: sentence
---

#Task 1

In this task we design an reduced experimental design to study the impact of different car setup parameters and strategy-related factors.
As seen in the last problem set we have several variables. Some of those variables are predetermined and track specific. Since they do not vary within the practice or the race and are fixed we cannot include them in the experimental design.
The setup variables can be influenced by the racing team. Those are "Rear Wing", "Front Wing", "Engine", "Brake Balance", "Differential" and "Suspension". In this problem set we additionally have strategy relevant variables. We can now choose how many pitstops we do and when we do them, tyres and fuel load. 
Since we do not have any previous data on the strategy relevant variables it is important to learn about the influences of those on the lap time and overall race time. It is of significant importance to find out how durable the tyres are and how they influence the lap time. The same applies to fuel load. It is also important to do some pit stops to estimate how much time is lost per pit stop. Since the pit stops are determined by tyre changes we do not explicitly include them as a factor in the experimental design as we learn about them indirectly. The fuel load will decrease during the practice. Therefore we do not include it explicitly as a factor in the experimental design and just fuel up the car to the maximum after every tyre change.

The LASSO results of the previous problem set indicate that lap time is strongly influenced by several car setup parameters and their interactions with track and environmental conditions. Every retained variable involves at least one controllable car feature. In particular, brake balance, differential, engine, and front and rear wing settings appear repeatedly with sizable coefficients, suggesting that drivetrain and aerodynamic configuration are key performance drivers. 
Therefore, we choose all setup variables as strong drivers of performance.

From the previous problem set we know that the relationship between car setup variables and lap times is  non-linear. While a two-level design can only identify general trends, the inclusion of a medium value allows the model to capture curvature and diminishing returns, which are critical for identifying the "sweet spot" in a complex mechanical system. 
However, a three-level design may oversimplify the complex physical interactions of racecar dynamics. A response surface with only three points assumes a symmetric curvature, which risks missing the true optimum if the performance curve is skewed or asymptotic. By extending the design to five levels, we gain the resolution necessary to capture higher-order non-linearities and subtle changes in vehicle behavior. This finer granularity is critical for distinguishing between a broad performance plateau and a narrow, sensitive peak, ensuring that the final optimal setting is precise rather than just an approximation between two extremes.

Regarding the tyres we expect that a softer compound results in faster lap times but higher degradation. For the qualifying the super-soft tyre therefore makes sense. It is still important to use the other three tyres to learn when it makes sense to use a softer tyre with an additional pit stop as opposed to a harder tyre.
The resulting factors that we believe influence the lap time are:
\begin{itemize} 
\item Rear Wing: 10 / 130 / 250 / 370 / 500 
\item Front Wing: 10 / 130 / 250 / 370 / 500 
\item Engine: 10 / 130 / 250 / 370 / 500 
\item Brake Balance: 10 / 130 / 250 / 370 / 500 
\item Differential: 10 / 130 / 250 / 370 / 500 
\item Suspension: 10 / 130 / 250 / 370 / 500 
\item Tyre: super-soft / soft / medium / hard \end{itemize}

From the Team Analytics Website we get the following information from Gunnar:
"One thing we did was to debunk the myth that setup should be changed according to fuel load or the tyres."
This implies that setup factors can be optimized independently of tyres and fuel load. And strategy factors can be evaluated holding setup fixed. This allows us to separate the experiment into two phases.

In the first phase we estimate the main effects of the six setup variables, holding tyre compound and fuel strategy constant. As a full factorial design is not feasible we use D-optimality to come up with an experimental design, which maximizes the precision of the car setup coefficients given a limited amount of experimental runs (70=120- 50 laps for phase 2).
```{r, echo=FALSE}
library(AlgDesign)
levels_5 <- c(10, 130, 250, 370, 500)

setup_candidates <- expand.grid(
  RearWing     = levels_5,
  FrontWing    = levels_5,
  Engine       = levels_5,
  BrakeBalance = levels_5,
  Differential = levels_5,
  Suspension   = levels_5
)

phase1_model <- ~ RearWing + I(RearWing^2) +
                  FrontWing + I(FrontWing^2) +
                  Engine + I(Engine^2) +
                  BrakeBalance + I(BrakeBalance^2) +
                  Differential + I(Differential^2) +
                  Suspension + I(Suspension^2)

set.seed(123)

phase1_design <- optFederov(
  frm       = phase1_model,
  data      = setup_candidates,
  nTrials   = 70,      # reduced number of practice laps
  criterion = "D"
)

#print(paste("D-efficiency:",phase1_design$Dea))

# The actual experimental plan
phase1_plan <- phase1_design$design
cor_matrix <- cor(phase1_plan)
off_diag_elements <- cor_matrix[row(cor_matrix) != col(cor_matrix)]
max_abs_corr <- max(abs(off_diag_elements))
#print(paste("Maximum absolute off-diagonal correlation:", max_abs_corr))

#print(phase1_plan)


```

The resulting design achieves a solid D-efficiency of 42,1% and maintains low correlations between the factors with the larges absolute correlation being 0,16. This ensures that the influence of each individual parameter can be statistically isolated during analysis. Consequently, this approach maximizes the information gathered about the vehicle's performance while significantly minimizing the total number of practice laps required for testing when compared to a full factorial design.

In the second phase the setup is fixed and we compare tyre compounds to understand lap time and degradation trade-offs as well as implicit pit stop costs.
Because the number of strategy factors is small and the factor levels are few, a full factorial design is feasible and preferred, as it allows unbiased and transparent comparison of all tyre compounds without confounding. This full factorial design ensures that differences in lap time and degradation across tyre types can be directly attributed to the tyre choice, providing a clear basis for race strategy decisions. We assume that softer tyre compounds degrade faster but achieve shorter lap times than harder compounds. To efficiently learn about degradation behavior under a limited lap budget, we run longer stints on the extreme compounds (super-soft and hard), which are expected to bracket the degradation patterns of the intermediate compounds. Shorter stints on the soft and medium tyres are still included to directly observe their performance levels, while the longer stints on the extremes improve identification of degradation dynamics. Therefore we decide to run 15 laps on the super-soft, 25 laps on the hard tyre and 5 laps on the soft and medium tyre each.

```{r, echo=FALSE}
# Fixed setup from Phase 1 optimum
fixed_setup <- data.frame(
  RearW     = 500,
  FrontW    = 500,
  Engine       = 500,
  BrakeBalance = 500,
  Differential = 500,
  Suspension   = 10
)

# Define stint lengths per tyre compound
laps_per_tyre <- data.frame(
  Tyre = factor(c("super_soft", "soft", "medium", "hard"),
                levels = c("super_soft", "soft", "medium", "hard")),
  Laps = c(15, 5, 5, 25)
)

# Create full factorial design within each tyre compound
strategy_factors <- do.call(
  rbind,
  lapply(1:nrow(laps_per_tyre), function(i) {
    data.frame(
      Tyre = laps_per_tyre$Tyre[i],
      Lap  = 1:laps_per_tyre$Laps[i]
    )
  })
)

# Combine fixed setup with strategy design
phase2_design <- cbind(
  fixed_setup[rep(1, nrow(strategy_factors)), ],
  strategy_factors
)

# Inspect design
table(phase2_design$Tyre)
head(phase2_design)

```
1. Experiment: 25 Laps, Hart, mit 120 Fuel
--> Reifen degradiert linear
--> Fuel level linear abnehmend
--> Einfluss von Fuel auf Laptime scheint größer zu sein von Reifen (da Rundenzeit sinkt)

2. Experiment: 2 Laps, Soft, 5 Fuel
--> Fuel level linear abnehmend, egal welcher Reifen drauf ist
--> Reifen degration höher für weichen Reifen

Idee: Wenn Fuel und Reifen unabhängig von einander degradieren, können wir mehrere Stints mit einer Runde fahren, um immer mit neuem Reifen zu starten (diesen also konstant halten). So können wir, wenn wir den Fuel ändern, den Einfluss von Fuel auf die Rundenzeit ermitteln.

3. Experiment: 5 Stints a 1 Runde, Soft, Fuel 100/80/60/40/20, weil 120 haben wir ja schon.

Um zu prüfen, ob das Fuel Level mit unterschiedlichen Reifen einen Einfluss auf die Rundenzeit hat, machen wir das dritte Experiment nochmal mit dem harten Reifen.


4. Experiment: 5 Stints a 1 Runde, Hart, Fuel 100/80/60/40/20, weil 120 haben wir ja schon

Dann müssen wir nur noch die unterschiedlichen Reifen testen.
4. Experiment: 15 Runden, Soft, Fuel 120

5. Experiment: 3 Runden, Medium, Fuel 120

Frage: Müssen wir dieses Experiment für alle Reifen durchführen?
Frage: Können wir den Fehler, der auf die Rundenzeit addiert wird abschätzen?


Erkenntnisse:
Reifen degradiert linear, aber unterschiedlich für Reifenmischung
Fuel level linear abnehmend, egal welcher Reifen drauf ist
Super soft lässt sich nicht fahren, wahrscheinlich weil es zu warm ist
Pitstops können in der Practice nicht simuliert werden (es kann nicht mit zu wenig Sprit gestartet werden)
